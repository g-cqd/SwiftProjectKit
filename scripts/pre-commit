#!/bin/bash
#
# Pre-commit hook for SwiftProjectKit
# Run: ./scripts/install-hooks.sh to install
#
# Checks:
# 1. Format (auto-fix)
# 2. Format check (verify)
# 3. Version consistency
# 4. Build
# 5. Tests
# 6. Unused code detection (if swa available)
#

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find project root (where .git is)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
SCRIPTS_DIR="$PROJECT_ROOT/scripts"
cd "$PROJECT_ROOT"

# Check if swa is available
SWA_AVAILABLE=false
if command -v swa &> /dev/null; then
    SWA_AVAILABLE=true
fi

TOTAL_CHECKS=5
if [ "$SWA_AVAILABLE" = true ]; then
    TOTAL_CHECKS=6
fi

# 1. Format (auto-fix)
echo -e "\n${YELLOW}[1/$TOTAL_CHECKS] Formatting code...${NC}"
xcrun swift-format format --in-place --parallel --recursive Sources/ Tests/ Plugins/
git add -u  # Stage formatting changes
echo -e "${GREEN}Format applied${NC}"

# 2. Format check (verify)
echo -e "\n${YELLOW}[2/$TOTAL_CHECKS] Checking format...${NC}"
if ! xcrun swift-format lint --strict --parallel --recursive Sources/ Tests/ Plugins/ 2>&1; then
    echo -e "${RED}Format check failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Format check passed${NC}"

# 3. Version consistency check
echo -e "\n${YELLOW}[3/$TOTAL_CHECKS] Checking version consistency...${NC}"
if ! "$SCRIPTS_DIR/check-version.sh" 2>&1; then
    echo -e "${RED}Version check failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Version check passed${NC}"

# 4. Build
echo -e "\n${YELLOW}[4/$TOTAL_CHECKS] Building...${NC}"
if ! swift build 2>&1 | tail -5; then
    echo -e "${RED}Build failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Build passed${NC}"

# 5. Run tests
echo -e "\n${YELLOW}[5/$TOTAL_CHECKS] Running tests...${NC}"
if ! swift test --parallel 2>&1 | tail -5; then
    echo -e "${RED}Tests failed!${NC}"
    exit 1
fi
echo -e "${GREEN}Tests passed${NC}"

# 6. Unused code detection (if swa available)
if [ "$SWA_AVAILABLE" = true ]; then
    echo -e "\n${YELLOW}[6/$TOTAL_CHECKS] Checking for unused code...${NC}"
    UNUSED_OUTPUT=$(swa unused Sources/ --sensible-defaults --format xcode --exclude-paths .build 2>&1 || true)
    if [ -n "$UNUSED_OUTPUT" ]; then
        echo -e "${YELLOW}Unused code warnings:${NC}"
        echo "$UNUSED_OUTPUT" | head -20
        echo -e "${YELLOW}(Informational - not blocking commit)${NC}"
    else
        echo -e "${GREEN}No unused code found${NC}"
    fi
else
    echo -e "\n${YELLOW}[Skipped] swa not installed - skipping unused code check${NC}"
    echo -e "Install with: brew install g-cqd/tap/swa"
fi

echo -e "\n${GREEN}All pre-commit checks passed!${NC}"
exit 0
