name: CI/CD

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create release'
        type: boolean
        default: false
      version:
        description: 'Version override (e.g., 1.0.0)'
        required: false

permissions:
  contents: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  XCODE_VERSION: '26.1.1'
  SWA_VERSION: '1.0.6'

jobs:
  # ============================================================================
  # Stage 1: Setup - Cache SWA and SPK binaries
  # ============================================================================
  setup:
    name: Setup Tools
    runs-on: macos-15
    outputs:
      swa_path: ${{ steps.swa.outputs.path }}
      spk_path: ${{ steps.spk.outputs.path }}
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SWA Binary
        id: swa-cache
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/swa
          key: swa-${{ runner.os }}-${{ env.SWA_VERSION }}

      - name: Download SWA
        if: steps.swa-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.local/bin
          DOWNLOAD_URL="https://github.com/g-cqd/SwiftStaticAnalysis/releases/download/v${{ env.SWA_VERSION }}/swa-${{ env.SWA_VERSION }}-macos-universal.tar.gz"
          echo "Downloading SWA from ${DOWNLOAD_URL}..."
          if curl -fsSL "$DOWNLOAD_URL" -o /tmp/swa.tar.gz 2>/dev/null; then
            tar -xzf /tmp/swa.tar.gz -C ~/.local/bin
            chmod +x ~/.local/bin/swa
            echo "Downloaded SWA ${{ env.SWA_VERSION }}"
          else
            echo "Failed to download SWA, will skip analysis checks"
          fi

      - name: Verify SWA
        id: swa
        run: |
          if [[ -x ~/.local/bin/swa ]]; then
            echo "path=$HOME/.local/bin/swa" >> $GITHUB_OUTPUT
            ~/.local/bin/swa --version || true
          else
            echo "path=" >> $GITHUB_OUTPUT
            echo "SWA not available"
          fi

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Build SPK
        id: spk
        run: |
          swift build --product spk
          echo "path=$(pwd)/.build/debug/spk" >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 2: Code Quality Checks (Parallel)
  # ============================================================================
  format-check:
    name: Format Check
    runs-on: macos-15
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Setup SPK
        id: setup-spk
        run: |
          SPK_BINARY=".build/debug/spk"
          SPK_AVAILABLE=false

          # Get latest release tag from GitHub
          echo "Fetching latest spk release..."
          LATEST_TAG=$(curl -sI "https://github.com/g-cqd/SwiftProjectKit/releases/latest" | grep -i "^location:" | sed 's/.*tag\///' | tr -d '\r\n')

          if [[ -n "$LATEST_TAG" ]]; then
            SPK_VERSION="${LATEST_TAG#v}"
            DOWNLOAD_URL="https://github.com/g-cqd/SwiftProjectKit/releases/download/${LATEST_TAG}/spk-${SPK_VERSION}-macos-universal.tar.gz"
            echo "Attempting to download spk ${LATEST_TAG}..."
            if curl -fsSL "$DOWNLOAD_URL" -o /tmp/spk.tar.gz 2>/dev/null; then
              mkdir -p .build/debug
              tar -xzf /tmp/spk.tar.gz -C .build/debug
              chmod +x "$SPK_BINARY"
              SPK_AVAILABLE=true
              echo "Downloaded spk ${LATEST_TAG}"
            fi
          fi

          # Fall back to building from source
          if [[ "$SPK_AVAILABLE" != "true" ]]; then
            echo "Building spk from source..."
            swift build --product spk
            echo "Built spk from source"
          fi

          echo "spk_path=$SPK_BINARY" >> $GITHUB_OUTPUT

      - name: Check Formatting
        run: ${{ steps.setup-spk.outputs.spk_path }} format --lint

  unused-check:
    name: Unused Code Check
    runs-on: macos-15
    needs: setup
    if: needs.setup.outputs.swa_path != ''
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Restore SWA Binary
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/swa
          key: swa-${{ runner.os }}-${{ env.SWA_VERSION }}

      - name: Check Unused Code
        run: |
          ~/.local/bin/swa unused \
            --mode reachability \
            --paths Sources/ \
            --exclude-paths .build/ \
            --format xcode
        continue-on-error: true

  duplicates-check:
    name: Duplicates Check
    runs-on: macos-15
    needs: setup
    if: needs.setup.outputs.swa_path != ''
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Restore SWA Binary
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/swa
          key: swa-${{ runner.os }}-${{ env.SWA_VERSION }}

      - name: Check Duplicates
        run: |
          ~/.local/bin/swa duplicates \
            --min-tokens 100 \
            --paths Sources/ \
            --exclude-paths .build/ \
            --format xcode
        continue-on-error: true

  # ============================================================================
  # Stage 3: Tests with Coverage (After quality checks)
  # ============================================================================
  test:
    name: Build & Test
    runs-on: macos-15
    needs: [format-check, unused-check, duplicates-check]
    if: |
      always() &&
      needs.format-check.result == 'success' &&
      (needs.unused-check.result == 'success' || needs.unused-check.result == 'skipped') &&
      (needs.duplicates-check.result == 'success' || needs.duplicates-check.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Build
        run: swift build -c release

      - name: Run Tests with Coverage
        run: |
          swift test --parallel --enable-code-coverage

      - name: Generate Coverage Report
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          PROFDATA=$(find .build -name "*.profdata" | head -1)

          if [[ -n "$PROFDATA" ]] && [[ -f "$PROFDATA" ]]; then
            # Find test binary
            TEST_BINARY=$(find "$BIN_PATH" -name "*.xctest" -type d | head -1)
            if [[ -n "$TEST_BINARY" ]]; then
              EXEC_PATH="$TEST_BINARY/Contents/MacOS/$(basename "$TEST_BINARY" .xctest)"
              if [[ -f "$EXEC_PATH" ]]; then
                xcrun llvm-cov report "$EXEC_PATH" -instr-profile="$PROFDATA" > coverage.txt
                echo "Coverage Report:"
                cat coverage.txt
              fi
            fi
          else
            echo "No profdata found, skipping coverage report"
          fi
        continue-on-error: true

  # ============================================================================
  # Stage 4: Security Analysis (After tests)
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: macos-15
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: swift
          build-mode: manual

      - name: Build for CodeQL
        run: swift build -c release --arch arm64

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:swift"

  # ============================================================================
  # Stage 5: Prepare Release (After tests, parallel with CodeQL)
  # ============================================================================
  prepare-release:
    name: Prepare Release
    runs-on: macos-15
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.release) || github.event_name == 'push'
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      should_release: ${{ steps.version.outputs.should_release }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Setup SPK
        id: setup-spk
        run: |
          SPK_BINARY=".build/debug/spk"
          SPK_AVAILABLE=false

          # Get latest release tag from GitHub
          echo "Fetching latest spk release..."
          LATEST_TAG=$(curl -sI "https://github.com/g-cqd/SwiftProjectKit/releases/latest" | grep -i "^location:" | sed 's/.*tag\///' | tr -d '\r\n')

          if [[ -n "$LATEST_TAG" ]]; then
            SPK_VERSION="${LATEST_TAG#v}"
            DOWNLOAD_URL="https://github.com/g-cqd/SwiftProjectKit/releases/download/${LATEST_TAG}/spk-${SPK_VERSION}-macos-universal.tar.gz"
            echo "Attempting to download spk ${LATEST_TAG}..."
            if curl -fsSL "$DOWNLOAD_URL" -o /tmp/spk.tar.gz 2>/dev/null; then
              mkdir -p .build/debug
              tar -xzf /tmp/spk.tar.gz -C .build/debug
              chmod +x "$SPK_BINARY"
              SPK_AVAILABLE=true
              echo "Downloaded spk ${LATEST_TAG}"
            fi
          fi

          # Fall back to building from source
          if [[ "$SPK_AVAILABLE" != "true" ]]; then
            echo "Building spk from source..."
            swift build --product spk
            echo "Built spk from source"
          fi

          echo "spk_path=$SPK_BINARY" >> $GITHUB_OUTPUT

      - name: Determine Version
        id: version
        run: |
          # Try spk version first, fall back to .spk.json parsing
          if VERSION=$(${{ steps.setup-spk.outputs.spk_path }} version --quiet 2>/dev/null); then
            echo "Got version from spk: ${VERSION}"
          elif [[ -f ".spk.json" ]] && command -v jq &> /dev/null; then
            VERSION=$(jq -r '.project.version // empty' .spk.json)
          elif [[ -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            echo "No version source found"
            exit 1
          fi

          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

          # Check if this version already has a tag (skip release if so)
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists - skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "New version ${VERSION} - will create release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate Changelog
        id: changelog
        run: |
          PREVIOUS=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          RANGE="${PREVIOUS:+$PREVIOUS..}HEAD"

          {
            echo "content<<EOF"

            # Features
            FEATURES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^feat" --grep="^add" --grep="^new" -i 2>/dev/null | head -20 || echo "")
            if [[ -n "$FEATURES" ]]; then
              echo "### Features"
              echo "$FEATURES"
              echo ""
            fi

            # Bug Fixes
            FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^fix" -i 2>/dev/null | head -20 || echo "")
            if [[ -n "$FIXES" ]]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # Other changes
            OTHER=$(git log $RANGE --pretty=format:"- %s (%h)" --invert-grep --grep="^feat" --grep="^fix" --grep="^add" --grep="^new" -i 2>/dev/null | head -15 || echo "")
            if [[ -n "$OTHER" ]]; then
              echo "### Other Changes"
              echo "$OTHER"
              echo ""
            fi

            echo "EOF"
          } >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 6: Create Release with Binaries and Homebrew Formula
  # ============================================================================
  release:
    name: Create Release
    runs-on: macos-15
    needs: prepare-release
    if: needs.prepare-release.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Build Universal Binary
        run: |
          # Build for ARM64
          swift build -c release --arch arm64
          cp .build/arm64-apple-macosx/release/spk .build/spk-arm64

          # Build for x86_64
          swift build -c release --arch x86_64
          cp .build/x86_64-apple-macosx/release/spk .build/spk-x86_64

          # Create universal binary
          mkdir -p .build/release
          lipo -create -output .build/release/spk \
            .build/spk-arm64 \
            .build/spk-x86_64

          lipo -info .build/release/spk

      - name: Package Binaries
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          mkdir -p release

          for ARCH in universal arm64 x86_64; do
            if [[ "$ARCH" == "universal" ]]; then
              cp .build/release/spk release/spk
            else
              cp .build/spk-$ARCH release/spk
            fi
            tar -C release -czvf "release/spk-${VERSION}-macos-${ARCH}.tar.gz" spk
          done

          cd release && shasum -a 256 *.tar.gz > checksums.txt

      - name: Generate Homebrew Formula
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          TAG="${{ needs.prepare-release.outputs.tag }}"

          # Read checksums
          ARM64_SHA=$(grep "arm64" release/checksums.txt | awk '{print $1}')
          X86_SHA=$(grep "x86_64" release/checksums.txt | awk '{print $1}')
          UNIVERSAL_SHA=$(grep "universal" release/checksums.txt | awk '{print $1}')

          cat > release/spk.rb << FORMULA_EOF
          class Spk < Formula
            desc "Swift project scaffolding and management CLI"
            homepage "https://github.com/g-cqd/SwiftProjectKit"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/g-cqd/SwiftProjectKit/releases/download/${TAG}/spk-${VERSION}-macos-arm64.tar.gz"
                sha256 "${ARM64_SHA}"
              else
                url "https://github.com/g-cqd/SwiftProjectKit/releases/download/${TAG}/spk-${VERSION}-macos-x86_64.tar.gz"
                sha256 "${X86_SHA}"
              end
            end

            def install
              bin.install "spk"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/spk --version")
            end
          end
          FORMULA_EOF

      - name: Create Tag
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.prepare-release.outputs.tag }}" -m "Release ${{ needs.prepare-release.outputs.version }}" || true
          git push origin "${{ needs.prepare-release.outputs.tag }}" || true

      - name: Prepare Release Notes
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          TAG="${{ needs.prepare-release.outputs.tag }}"
          cat > release_notes.md << RELEASE_EOF
          ## SwiftProjectKit ${VERSION}

          ${{ needs.prepare-release.outputs.changelog }}

          ---

          ### Installation

          **Homebrew:**
          \`\`\`bash
          brew tap g-cqd/tap
          brew install spk
          \`\`\`

          **Swift Package Manager:**
          \`\`\`swift
          dependencies: [
              .package(url: "https://github.com/g-cqd/SwiftProjectKit.git", from: "${VERSION}")
          ]
          \`\`\`

          **Pre-built Binary (macOS):**
          \`\`\`bash
          # Universal (Apple Silicon + Intel)
          curl -L https://github.com/g-cqd/SwiftProjectKit/releases/download/${TAG}/spk-${VERSION}-macos-universal.tar.gz | tar xz
          sudo mv spk /usr/local/bin/
          \`\`\`

          ### Checksums

          \`\`\`
          $(cat release/checksums.txt)
          \`\`\`

          RELEASE_EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: SwiftProjectKit ${{ needs.prepare-release.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.prepare-release.outputs.version, 'alpha') || contains(needs.prepare-release.outputs.version, 'beta') || contains(needs.prepare-release.outputs.version, 'rc') }}
          files: |
            release/spk-${{ needs.prepare-release.outputs.version }}-macos-*.tar.gz
            release/checksums.txt
            release/spk.rb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
