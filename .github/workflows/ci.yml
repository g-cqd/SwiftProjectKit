name: CI/CD

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.0)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  XCODE_VERSION: '26.1.1'

jobs:
  # ============================================================================
  # Stage 1: Code Quality (Always runs)
  # ============================================================================
  lint:
    name: Lint
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Ensure Linting Tools
        run: |
          command -v swiftlint >/dev/null 2>&1 || brew install swiftlint
          command -v swiftformat >/dev/null 2>&1 || brew install swiftformat

      - name: SwiftLint
        run: swiftlint lint --reporter github-actions-logging

      - name: SwiftFormat
        run: swiftformat --lint .

  # ============================================================================
  # Stage 2: Build & Test (Always runs, depends on lint)
  # ============================================================================
  build-and-test:
    name: Build & Test
    runs-on: macos-15
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Ensure Linting Tools
        run: |
          command -v swiftlint >/dev/null 2>&1 || brew install swiftlint
          command -v swiftformat >/dev/null 2>&1 || brew install swiftformat

      - name: Build
        run: swift build -c release

      - name: Run Tests
        run: swift test --parallel

  # ============================================================================
  # Stage 3: Security Analysis (Always runs, depends on lint)
  # ============================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: macos-15
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Ensure Linting Tools
        run: |
          command -v swiftlint >/dev/null 2>&1 || brew install swiftlint
          command -v swiftformat >/dev/null 2>&1 || brew install swiftformat

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: swift
          build-mode: manual

      - name: Build for CodeQL
        run: swift build -c release --arch arm64

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:swift"

  # ============================================================================
  # Stage 4: Release Validation (Tags, workflow_dispatch, or push to main)
  # ============================================================================
  validate-release:
    name: Validate Release
    runs-on: macos-15
    needs: build-and-test
    # Run on: tags, workflow_dispatch, or push to main (excluding bot commits and [skip release])
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip release]') && !contains(github.event.head_commit.author.name, 'github-actions'))
    outputs:
      version: ${{ steps.version.outputs.version }}
      previous_tag: ${{ steps.previous.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            # Auto-increment: get latest tag and bump patch version
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            LATEST_VERSION="${LATEST_TAG#v}"

            # Parse semver
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
            PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${PATCH}"

            echo "Auto-incrementing from $LATEST_VERSION to $VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Get Previous Tag
        id: previous
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 5: Generate Changelog (Tags and workflow_dispatch, runs on Linux)
  # ============================================================================
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate-release
    outputs:
      changelog: ${{ steps.generate.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: generate
        run: |
          PREV_TAG="${{ needs.validate-release.outputs.previous_tag }}"
          VERSION="${{ needs.validate-release.outputs.version }}"

          {
            echo 'changelog<<EOF'
            echo "## What's Changed in v$VERSION"
            echo ""

            if [[ -n "$PREV_TAG" ]]; then
              echo "### Commits"
              git log $PREV_TAG..HEAD --pretty=format:"- %h %s (%an)" | head -50
            else
              echo "Initial release"
              git log --pretty=format:"- %h %s (%an)" | head -50
            fi

            echo ""
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  # ============================================================================
  # Stage 6: Create GitHub Release (Tags and workflow_dispatch)
  # ============================================================================
  release:
    name: Create Release
    runs-on: macos-15
    needs: [validate-release, changelog]
    steps:
      - uses: actions/checkout@v4

      - name: Create Tag
        # Create tag on workflow_dispatch (if requested) or push to main (not when already triggered by a tag)
        if: |
          (github.event_name == 'workflow_dispatch' && inputs.create_tag) ||
          (github.event_name == 'push' && github.ref == 'refs/heads/main')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.validate-release.outputs.version }}" -m "Release v${{ needs.validate-release.outputs.version }}" || true
          git push origin "v${{ needs.validate-release.outputs.version }}" || true

      - name: Prepare Release Notes
        run: |
          cat > release_notes.md << 'RELEASE_EOF'
          # SwiftProjectKit v${{ needs.validate-release.outputs.version }}

          ${{ needs.changelog.outputs.changelog }}

          ---

          ## Installation

          ### Swift Package Manager

          ```swift
          dependencies: [
              .package(url: "https://github.com/g-cqd/SwiftProjectKit.git", from: "${{ needs.validate-release.outputs.version }}")
          ]
          ```

          RELEASE_EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate-release.outputs.version }}
          name: SwiftProjectKit v${{ needs.validate-release.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.validate-release.outputs.version, 'alpha') || contains(needs.validate-release.outputs.version, 'beta') || contains(needs.validate-release.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
